<th:block th:fragment="body">
	<div class="block-header">
        <h2>COTIZACIONES</h2>
    </div>
    
    <ol class="breadcrumb breadcrumb-bg-red">
      	<li><a th:href="${ {_PATH_} + 'controlPanel/'}"><i class="material-icons">home</i> Inicio</a></li>
    	<li><a th:href="${ {_PATH_} + 'controlPanel/cotizaciones'}"><i class="material-icons">view_list</i> Cotizaciones</a></li>
    	<li class="active"> Nuevo</li>
  	</ol>
    
    <div class="row clearfix">
    	<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
    		<div class="card">
    			<div class="header">
    				<h2>Nueva Cotizaci&oacute;n</h2>
    			</div>
    			
    			<div class="body">
    				<form id="formCotizacion" th:action="${ {_PATH_} + 'controlPanel/cotizaciones'}" th:method="POST">
    					<input th:if="${objOportunidad != null}" type="hidden" name="hddIdOportunidad" th:value="${objOportunidad.getIdOportunidadNegocio()}" />
    				
						<div class="row clearfix">
							<div class="col-md-4">
	                            <p><b>Usuario *</b></p>
	                            <select class="form-control show-tick" name="cmbUsuario" id="cmbUsuario" data-live-search="true" >
	                       			<th:block th:each="itemUsuario : ${lstUsuarios}" >
	                       				<option th:if="${itemUsuario.idUsuario == _USER_.getIdUsuario()}" selected="selected" th:value="${itemUsuario.idUsuario}" th:text="${itemUsuario.nombreCompleto}"></option>
	                       				<option th:unless="${itemUsuario.idUsuario == _USER_.getIdUsuario()}" th:value="${itemUsuario.idUsuario}" th:text="${itemUsuario.nombreCompleto}"></option>
	                       			</th:block>
	                       		</select>
	                        </div>
	                        
	                        <div class="col-md-4">
	                            <p><b>Empresa *</b></p>
	                            <select class="form-control show-tick" name="cmbEmpresa" id="cmbEmpresa" data-live-search="true" >
	                       			<th:block th:each="itemEmpresa : ${lstEmpresas}" >
	                       				<option th:value="${itemEmpresa.idEmpresa}" th:text="${itemEmpresa.razonSocial}"></option>
	                       			</th:block>
	                       		</select>
	                        </div>
	                        
	                        <div class="col-md-4">
	                        	<div class="form-group">
	                        		<p><b>Concepto *</b></p>
	                                <div class="form-line">
	                                    <input type="text" name="txtConcepto" class="form-control" required="required" />
	                                </div>
	                            </div>
	                        </div>
						</div>
						
						<div class="row clearfix">
							<div class="col-md-4">
	                      		<b>Fecha de solicitud *</b>
	                        	<div class="input-group">
                        			<span class="input-group-addon">
                                        <i class="material-icons">date_range</i>
                                    </span>
                                    <div class="form-line">
                                        <input type="text" class="form-control text-center" id="txtSolicitudFecha" name="txtSolicitudFecha" readonly="readonly" />
                                    </div>
								</div>
							</div>
							
							<div class="col-md-4">
								<b>Cliente *</b>
								<div class="input-group">								
		                            <select class="form-control show-tick" name="cmbCliente" id="cmbCliente" data-live-search="true" >
		                            	<option value="default" selected="selected">Selecciona un Cliente...</option>
		                            	<option th:each="itemCliente : ${lstClientes}" th:value="${itemCliente.idCliente}" th:text="${itemCliente.cliente}"></option>
		                       		</select>
		                       		<!-- <span class="input-group-addon">
		                       			<a href="#" data-toggle="modal" data-target="#clienteModal">		                       			
	                                        <i class="material-icons">add_circle</i>
		                       			</a>
                                    </span> -->
								</div>	                           
	                        </div>
	                        
	                        <div class="col-md-4">
	                            <b>Contacto *</b>
	                            <div class="input-group">	                            
		                            <select class="form-control show-tick" name="cmbClienteContacto" id="cmbClienteContacto" data-live-search="true" >
		                            	<option value="default" selected="selected">Selecciona un Contacto...</option>
		                            </select>
		                            <!-- <span class="input-group-addon">
		                       			<a href="#" data-toggle="modal" data-target="#contactoModal">		                       			
	                                        <i class="material-icons">add_circle</i>
		                       			</a>
                                    </span> -->
	                            </div>
	                        </div>
						</div>
						
						<div class="row clearfix">
							<div class="col-md-3">
	                        	<div class="form-group">
	                        		<p><b>Ubicaci&oacute;n *</b></p>
	                                <div class="form-line">
	                                    <input type="text" name="txtUbicacion" class="form-control" required="required" />
	                                </div>
	                            </div>
	                        </div>
	                        
	                        <div class="col-md-3">
	                        	<div class="form-group">
	                        		<p><b>Lugar de entrega *</b></p>
	                                <div class="form-line">
	                                    <input type="text" name="txtLugarEntrega" class="form-control" required="required" />
	                                </div>
	                            </div>
	                        </div>
	                        
	                        <div class="col-md-3">
	                        	<div class="form-group">
	                        		<p><b>Tiempo de entrega *</b></p>
	                                <div class="form-line">
	                                    <input type="text" name="txtTiempoEntrega" class="form-control" placeholder="D&iacute;as h&aacute;biles" required="required" />
	                                </div>
	                            </div>
	                        </div>
	                        
	                        <div class="col-md-3">
	                        	<div class="form-group">
	                        		<p><b>Vigencia de precios *</b></p>
	                                <div class="form-line">
	                                    <input type="text" name="txtVigenciaPrecios" class="form-control" placeholder="D&iacute;as h&aacute;biles" required="required" />
	                                </div>
	                            </div>
	                        </div>
						</div>
					
						<div class="row clearfix">
							<div class="col-md-3">
								<p><b>Moneda *</b></p>
	                            <select class="form-control show-tick" name="cmbMoneda" id="cmbMoneda" data-live-search="true">
	                            	<option th:each="itemMoneda : ${lstMonedas}" th:value="${itemMoneda.idMoneda}" th:text="${itemMoneda.moneda}"></option>
	                       		</select>
							</div>
							
							<div class="col-md-3">
								<p><b>Forma de pago *</b></p>
	                            <select class="form-control show-tick" name="cmbFormaPago" id="cmbFormaPago" data-live-search="true">
	                            	<option th:each="itemFormaPago : ${lstFormasPagos}" th:value="${itemFormaPago.idFormaPago}" th:text="${itemFormaPago.formaPago}"></option>
	                       		</select>
							</div>
							
							<div class="col-md-2">
								<div class="form-group">
	                        		<p><b>D&iacute;as de cr&eacute;dito</b></p>
	                                <div class="form-line">
	                                    <input type="text" name="txtDiasCredito" class="form-control" placeholder="e.g. 3 d&iacute;as" />
	                                </div>
	                            </div>
							</div>							
						</div>
						
						<hr />
						<div style="margin-bottom: 30px;">						
							<h4>Venta e Implementaci&oacute;n</h4>
						</div>
						
						<div class="row clearfix">
							<div class="col-md-4">
	                            <p><b>Vendedor *</b></p>
	                            <select class="form-control show-tick" name="cmbVendedor" id="cmbVendedor" data-live-search="true" disabled="disabled" >
	                       			<th:block th:each="itemUsuario : ${lstUsuarios}" >
	                       				<option th:if="${itemUsuario.idUsuario == _USER_.getIdUsuario()}" selected="selected" th:value="${itemUsuario.idUsuario}" th:text="${itemUsuario.nombreCompleto}"></option>
	                       				<option th:unless="${itemUsuario.idUsuario == _USER_.getIdUsuario()}" th:value="${itemUsuario.idUsuario}" th:text="${itemUsuario.nombreCompleto}"></option>
	                       			</th:block>
	                       		</select>
	                        </div>
	                        
	                        <div class="col-md-2">
                        		<input type="checkbox" id="chkVentaCompartida" name="chkVentaCompartida" value="true" class="chk-col-red" />
                               	<label for="chkVentaCompartida">&iquest;VENTA COMPARTIDA?</label>
	                        </div>
	                        
	                        <div class="col-md-2">
                        		<input type="checkbox" id="chkImplementacion" name="chkImplementacion" value="true" class="chk-col-purple" />
                               	<label for="chkImplementacion">&iquest;REQUIERE IMPLEMENTACI&Oacute;N?</label>
	                        </div>
	                        
	                        <div class="col-md-4">
	                            <p><b>Implementador</b></p>
	                            <select class="form-control show-tick" name="cmbImplementador" id="cmbImplementador" data-live-search="true" disabled="disabled" >
	                       			<th:block th:each="itemUsuario : ${lstUsuariosGrupos}" >
	                       				<option th:value="${itemUsuario.idUsuario}" th:text="${itemUsuario.nombreCompleto}" th:attr="data-subtext=${itemUsuario.usuarioGrupo.usuarioGrupo}"></option>
	                       			</th:block>
	                       		</select>
	                        </div>
						</div>						
						
						<hr />
						<div style="margin-bottom: 30px;">
							<h4>Tipo de Cotizaci&oacute;n</h4>
						</div>
						
						<div class="row clearfix">
							<div class="col-md-12">
	                        	<input name="rdTipoCotizacion" type="radio" id="rdMaster" class="with-gap radio-col-red" value="master" />
                                <label for="rdMaster"><strong>Maestra</strong> (Ej. Cotizaci&oacute;n principal de una p&oacute;liza)</label>
                                
                                <input name="rdTipoCotizacion" type="radio" id="rdRenta" class="with-gap radio-col-purple" value="renta" />
                                <label for="rdRenta"><strong>Renta</strong> (Ej. Cotizaci&oacute;n mensual de una p&oacute;liza)</label>
                                
                                <input name="rdTipoCotizacion" type="radio" id="rdNormal" class="with-gap radio-col-blue" value="normal" checked="checked" />
								<label for="rdNormal"><strong>Normal</strong> (Ej. Cualquier tipo de cotizaci&oacute;n que no sea p&oacute;liza)</label>
								
								<input name="rdTipoCotizacion" type="radio" id="rdBoom" class="with-gap radio-col-red" value="boom" />
                                <label for="rdBoom"><strong>Boom</strong> (Ej. Cotizaci&oacute;n mayor. Principal de una p&oacute;liza)</label>
	                        </div>
						</div>
						
						<hr />
						<div style="margin-bottom: 30px;">						
							<h4>Informaci&oacute;n Adicional</h4>
						</div>
					
						<div class="row clearfix">
							<div class="col-md-6">
								<div class="form-group">
	                        		<p><b>Condiciones de pago</b></p>
                                    <div class="form-line">
                                        <textarea rows="4" name="txtCondicionesPago" class="form-control no-resize"></textarea>
                                    </div>
                                 </div>
							</div>
							
							<div class="col-md-6">
								<div class="form-group">
	                        		<p><b>Observaciones</b></p>
                                    <div class="form-line">
                                        <textarea rows="4" name="txtObservaciones" class="form-control no-resize"></textarea>
                                    </div>
                                 </div>
							</div>
						</div>
					
						<div class="row clearfix">
							<div class="col-md-3 col-md-offset-8 text-right">
								<a th:href="${ {_PATH_} + 'controlPanel/cotizaciones'}" role="button" class="btn btn-danger m-t-15 waves-effect">CANCELAR</a>
								<button type="submit" class="btn btn-primary m-t-15 waves-effect">CREAR</button>
							</div>
						</div>
					</form>
    			</div>
    		</div>
    	</div>
    </div>
    
    <!-- CLIENTE MODAL -->
    <div class="modal fade" id="clienteModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            	<form id="formCliente" th:action="${ {_PATH_} + 'controlPanel/clientes/add-cliente'}" th:method="POST">
	                <div class="modal-header">
	                    <h4 class="modal-title" id="defaultModalLabel">Nuevo Cliente</h4>
	                </div>
	                <div class="modal-body">
	                    <div class="row clearfix">
							<div class="col-md-8">
	                        	<div class="form-group">
	                        		<p><b>Nombre Comercial *</b></p>
	                                <div class="form-line">
	                                    <input type="text" name="txtNombreComercial" class="form-control" required="required" />
	                                </div>
	                            </div>
	                        </div>
	                        
							<div class="col-md-4">
	                            <p><b>Sucursal *</b></p>
	                            <select class="form-control show-tick" name="cmbSucursal" id="cmbSucursal" data-live-search="true" >
	                       			<th:block th:each="itemSucursal : ${lstSucursales}" >
	                       				<option th:if="${itemSucursal.idSucursal == _USER_.getSucursal().getIdSucursal()}" selected="selected" th:value="${itemSucursal.idSucursal}" th:text="${itemSucursal.sucursal}"></option>
	                       				<option th:unless="${itemSucursal.idSucursal == _USER_.getSucursal().getIdSucursal()}" th:value="${itemSucursal.idSucursal}" th:text="${itemSucursal.sucursal}"></option>
	                       			</th:block>
	                       		</select>
	                        </div>	                        	                       
						</div>
						
						<div class="row clearfix">
							<div class="col-md-4">
	                            <p><b>Giro</b></p>
	                            <select class="form-control show-tick" name="cmbGiro" id="cmbGiro" data-live-search="true" >
	                            	<option th:each="itemGiro : ${lstClientesGiros}" th:value="${itemGiro.idClienteGiro}" th:text="${itemGiro.clienteGiro}"></option>
	                       		</select>
	                        </div>
						
							<div class="col-md-4">
	                        	<div class="form-group">
	                        		<p><b>Raz&oacute;n social*</b></p>
	                                <div class="form-line">
	                                    <input type="text" name="txtRazonSocial" class="form-control" required="required" />
	                                </div>
	                            </div>
	                        </div>
	                        
	                       <div class="col-md-4">
								<div class="form-group">
	                        		<p><b>RFC *</b></p>
	                                <div class="form-line">
	                                    <input type="text" name="txtRFC" class="form-control" required="required" />
	                                </div>
	                            </div>
							</div>
						</div>
	                </div>
	                <div class="modal-footer">	                    
	                    <button type="button" class="btn btn-link waves-effect" data-dismiss="modal">CANCELAR</button>
	                    <button type="submit" class="btn btn-link waves-effect">CREAR</button>
	                </div>
                </form>
            </div>
        </div>
    </div>

	<!-- CONTACTO MODAL -->
    <div class="modal fade" id="contactoModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            	<form id="formContacto" th:action="${ {_PATH_} + 'controlPanel/clientes/add-contacto'}" th:method="POST">
            		<input type="hidden" value="" name="hddIdCliente" id="hddIdCliente" />
	                <div class="modal-header">
	                    <h4 class="modal-title" id="defaultModalLabel">Nuevo Contacto</h4>
	                </div>
	                <div class="modal-body">
	                    <div class="row clearfix">
	                        <div class="col-md-6">
	                        	<div class="form-group">
	                        		<p><b>Contacto *</b></p>
	                                <div class="form-line">
	                                    <input type="text" name="txtContacto" class="form-control" required="required" />
	                                </div>
	                            </div>
	                        </div>
	                        
	                        <div class="col-md-4">
                        		<input type="checkbox" id="chkAdministrador" name="chkAdministrador" value="true" class="chk-col-red" />
                               	<label for="chkAdministrador">&iquest;PROPIETARIO / GERENTE?</label>
	                        </div>
						</div>
						
						<div class="row clearfix">
							<div class="col-md-3">
								<div class="form-group">
	                        		<p><b>Puesto</b></p>
                                    <div class="form-line">
                                        <input type="text" name="txtPuesto" class="form-control" />
                                    </div>
                                 </div>
							</div>
							
							<div class="col-md-3">                        	
	                        	<div class="form-group">
	                        		<p><b>Correo *</b></p>
	                                <div class="form-line">
	                                    <input type="text" name="txtCorreo" class="form-control" required="required" />
	                                </div>
	                            </div>
	                        </div>
	                        
	                        <div class="col-md-3">                        		
	                        	<div class="form-group">
	                        		<p><b>Tel&eacute;fono</b></p>
	                                <div class="form-line">
	                                    <input type="text" name="txtTelefono" class="form-control" />
	                                </div>
	                            </div>
	                        </div>
	                        
	                        <div class="col-md-3">                        		
	                        	<div class="form-group">
	                        		<p><b>Celular *</b></p>
	                                <div class="form-line">
	                                    <input type="text" name="txtCelular" class="form-control" required="required" />
	                                </div>
	                            </div>
	                        </div>
						</div>
	                </div>
	                <div class="modal-footer">	                    
	                    <button type="button" class="btn btn-link waves-effect" data-dismiss="modal">CANCELAR</button>
	                    <button type="submit" class="btn btn-link waves-effect">CREAR</button>
	                </div>
                </form>
            </div>
        </div>
    </div>
</th:block>

<th:block th:fragment="script">
	<script type="application/javascript" th:inline="javascript">/*<![CDATA[*/
			
		var idUsuario = [[${_USER_.getIdUsuario()}]];
	
		$(document).ready(function() {
			//DATEPICKER
			$('#txtSolicitudFecha').bootstrapMaterialDatePicker({format: 'DD/MM/YYYY', weekStart : 1, clearButton: false, time:false, minDate : new Date()});
			$('#txtSolicitudFecha').bootstrapMaterialDatePicker('setDate', moment());
			
			// SELECT PICKER
			$('#cmbCliente option').attr('selected', false);
			
			$('#cmbCliente').on('change', function() {
				buscarContactos();
			});
			
			
			$('#chkVentaCompartida').on('change', function() {				
				if($(this).prop('checked')) {
					$('#cmbVendedor').prop('disabled', false);
					$('#cmbVendedor').selectpicker('refresh');
				} else {
					$('#cmbVendedor').prop('disabled', true);
					$('#cmbVendedor').selectpicker('refresh');
				}
			});
			
			
			$('#chkImplementacion').on('change', function() {				
				if($(this).prop('checked')) {
					$('#cmbImplementador').prop('disabled', false);
					$('#cmbImplementador').selectpicker('refresh');
				} else {
					$('#cmbImplementador').prop('disabled', true);
					$('#cmbImplementador').selectpicker('refresh');
				}
			});
			
			
			$('#chkGeneraOportunidad').on('change', function() {				
				if($(this).prop('checked')) {
					$('#cmbGenerador').prop('disabled', false);
					$('#cmbGenerador').selectpicker('refresh');
				} else {
					$('#cmbGenerador').prop('disabled', true);
					$('#cmbGenerador').selectpicker('refresh');
				}
			});
			
			// FORM SUBMIT
			$('#formCotizacion').submit(function(e){
				var flag = false;
				
				if($('#cmbCliente').val() == 'default' || $('#cmbClienteContacto').val() == 'default') {
					flag = true;
				}				
				
				if(flag) {
					swal('Hey!', 'Los campos con (*) son obligatorios', 'warning');
					e.preventDefault();
				}
		  	});
			
			$('#formCliente').submit(function(e){
				e.preventDefault();
				
				var formData = $('#formCliente').serialize();
				
				$.ajax({
					url					: $('#formCliente').attr('action'),
					dataType			: 'json',
					data				: formData,
					type				: "POST",
					success				: function(data) {
						if(data.respuesta) {
							buscarClientes();
							swal(data.titulo, data.mensaje, 'success');
							$('#clienteModal').modal('hide');
						} else{
							swal('Error!', 'Ocurrio un error al crear el cliente, verifique su informacion.', 'error');
						}
					},
					error				: function(e) {
						console.log(e);
					}
				});
		  	});
			
			$('#formContacto').submit(function(e){
				e.preventDefault();				
				
				var data = $('#hddIdCliente').val()
				var formData = $('#formContacto').serialize();
				
				if(data != "") {					
					$.ajax({
						url					: $('#formContacto').attr('action'),
						dataType			: 'json',
						data				: formData,
						type				: "POST",
						success				: function(data) {
							if(data.respuesta) {
								buscarContactos();
								swal(data.titulo, data.mensaje, 'success');
								$('#contactoModal').modal('hide');
							} else{
								swal('Error!', 'Ocurrio un error al crear el contacto, verifique su informacion.', 'error');
							}
						},
						error				: function(e) {
							console.log(e);
						}
					});
				} else {
					swal('Advertencia!', 'Para crear un contacto, es necesario seleccionar un cliente. Verifique su informacion.', 'warning');
				}
				
		  	});
		});
		
		function buscarClientes() {
			var $select = $('#cmbCliente');
			
			$.ajax({
				url					: [[@{/controlPanel/clientes/get-clientes}]],
				dataType			: 'json',
				type				: "GET",
				success				: function(data) {
											 
					$select.find('option').remove();  
					$.each(data, function(key, value) 
					{
					    $select.append('<option value="' + value.idCliente + '" >' + value.cliente + '</option>');
					});
					
					$select.selectpicker('refresh');
				},
				error				: function(e) {
					console.log(e);
				}
			});
		}
		
		function buscarContactos() {
			var $select = $('#cmbClienteContacto');
			var data = $('#cmbCliente').val()
			$('#hddIdCliente').val(data);
			
			$.ajax({
				url					: [[@{/controlPanel/clientes/get-clientes-contactos}]] + "?idCliente=" + data,
				dataType			: 'json',
				type				: "GET",
				success				: function(data) {
					$select.attr('disabled', false);
											 
					$select.find('option').remove();  
					$.each(data, function(key, value) 
					{
					    $select.append('<option value=' + value.idClienteContacto + ' data-subtext="'+ value.correo +'">' + value.contacto + '</option>');
					});
					
					$select.selectpicker('refresh');
				},
				error				: function(e) {
					console.log(e);
					$select.attr('disabled', true);
					$select.empty();
				}
			});
		}
		
		
		$(function () {
			// VALIDADOR DE FORMULARIO
			$('#formCotizacion').validate({
		        rules: {
		            'txtTiempoEntrega': {
		                number: true
		            },
		            'txtVigenciaPrecios': {
		                number: true
		            },
		            'txtDiasCredito': {
		                number: true
		            }
		        },
		        highlight: function (input) {
		            $(input).parents('.form-line').addClass('error');
		        },
		        unhighlight: function (input) {
		            $(input).parents('.form-line').removeClass('error');
		        },
		        errorPlacement: function (error, element) {
		            $(element).parents('.form-group').append(error);
		        }
		    });
			
			//Custom Validations ===============================================================================
		    //Number
		    $.validator.addMethod('number', function (value, element) {
		        return value.match('[0-9]+');
		    },
		        'Por favor ingresa un n&uacute;mero.'
		    );
			
			//Select Picker
		    $.validator.addMethod("valueNotEquals", function(value, element, arg){
	    	  	return arg !== value;
	    	}, 
	    	 'Por favor selecciona una opci&oacute;n.'
	    	 );
		});				
		/*]]>*/</script>
</th:block>